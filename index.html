<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程試算工具</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --success: #16a34a;
            --accent: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 { font-size: 1.5rem; font-weight: 700; }
        header p { font-size: 0.85rem; opacity: 0.85; margin-top: 0.25rem; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--card);
            padding: 0.75rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .tab-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid transparent;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab-btn:hover { background: #e0e7ff; color: var(--primary); }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
            color: var(--primary);
        }

        .card .subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .formula-display {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-family: "Cambria Math", "Times New Roman", serif;
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .form-group { display: flex; flex-direction: column; }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--text);
        }

        .form-group label span {
            font-weight: 400;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .form-group input, .form-group select {
            padding: 0.6rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-unit-group {
            display: flex;
            gap: 0;
        }

        .input-unit-group input {
            flex: 1;
            border-radius: 8px 0 0 8px;
            border-right: none;
            min-width: 0;
        }

        .input-unit-group select.unit-select {
            width: auto;
            min-width: 70px;
            max-width: 100px;
            border-radius: 0 8px 8px 0;
            border-left: 1px solid var(--border);
            font-size: 0.8rem;
            padding: 0.4rem 0.3rem;
            background: #f8fafc;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .input-unit-group select.unit-select:focus {
            border-color: var(--primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.7rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 1rem;
        }

        .btn:hover { background: var(--primary-dark); }

        .btn-secondary {
            background: #64748b;
        }
        .btn-secondary:hover { background: #475569; }

        /* Results */
        .result-box {
            margin-top: 1rem;
            padding: 1rem 1.25rem;
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            border-radius: 8px;
            display: none;
        }

        .result-box.show { display: block; }

        .result-box h3 {
            font-size: 0.9rem;
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .result-item:last-child { border-bottom: none; }

        .result-item .label { color: var(--text-secondary); font-size: 0.9rem; }
        .result-item .value { font-weight: 700; color: var(--text); font-size: 0.95rem; }

        /* Diagram */
        .diagram-container {
            text-align: center;
            margin: 1rem 0;
        }

        .diagram-container svg {
            max-width: 100%;
            height: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .tab-nav { gap: 0.35rem; padding: 0.5rem; }
            .tab-btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
            .form-grid { grid-template-columns: 1fr; }
        }

        /* Print */
        @media print {
            header { position: static; }
            .tab-nav, .btn { display: none; }
            .tab-content { display: block !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
        }

        .unit-system-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .unit-system-selector label {
            font-size: 0.85rem;
            opacity: 0.85;
        }
        .unit-system-selector select {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
        }
        .unit-system-selector select option {
            color: #1e293b;
            background: white;
        }

        /* Coordinate tables for RC Column */
        .coord-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }
        .coord-table th, .coord-table td {
            border: 1px solid var(--border);
            padding: 0.3rem 0.5rem;
            text-align: center;
        }
        .coord-table th {
            background: var(--bg);
            font-weight: 600;
            font-size: 0.8rem;
        }
        .coord-table input {
            width: 70px;
            padding: 0.3rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        .coord-table input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .coord-table select {
            padding: 0.3rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .btn-sm {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0.25rem 0.15rem;
        }
        .btn-sm-primary {
            background: var(--primary);
            color: white;
        }
        .btn-sm-primary:hover { background: var(--primary-dark); }
        .btn-sm-danger {
            background: #ef4444;
            color: white;
        }
        .btn-sm-danger:hover { background: #dc2626; }
        .btn-sm-secondary {
            background: #64748b;
            color: white;
        }
        .btn-sm-secondary:hover { background: #475569; }
        .section-block {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .section-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .section-block h3 {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .preview-container {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-container svg {
            max-width: 100%;
            height: auto;
        }
        .inline-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

<header>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
        <div>
            <h1>&#9881; 工程試算工具</h1>
            <p>Engineering Calculator - 結構 / 材料 / 單位換算</p>
        </div>
        <div class="unit-system-selector">
            <label for="unit-system">單位制</label>
            <select id="unit-system" onchange="switchUnitSystem(this.value)">
                <option value="" selected>自訂</option>
                <option value="kN-m">kN - m</option>
                <option value="kgf-cm">Kgf - cm</option>
                <option value="tf-m">tf - m</option>
                <option value="N-mm">N - mm</option>
                <option value="tf-cm">tf - cm</option>
                <option value="kgf-m">Kgf - m</option>
            </select>
        </div>
    </div>
</header>

<div class="container">
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="beam">梁分析</button>
        <button class="tab-btn" data-tab="column">柱載重</button>
        <button class="tab-btn" data-tab="concrete">混凝土用量</button>
        <button class="tab-btn" data-tab="rebar">鋼筋計算</button>
        <button class="tab-btn" data-tab="rcbeam">RC梁設計</button>
        <button class="tab-btn" data-tab="rccolumn">RC柱設計</button>
        <button class="tab-btn" data-tab="unit">單位換算</button>
    </nav>

    <!-- ==================== 梁分析 ==================== -->
    <div class="tab-content active" id="tab-beam">
        <div class="card">
            <h2>簡支梁分析</h2>
            <p class="subtitle">均佈載重下的簡支梁 - 彎矩、剪力、撓度計算</p>
            <div class="formula-display">
                M_max = wL&sup2;/8 &nbsp;&nbsp;|&nbsp;&nbsp; V_max = wL/2 &nbsp;&nbsp;|&nbsp;&nbsp; &delta;_max = 5wL⁴ / (384EI)
            </div>
            <div class="diagram-container">
                <svg width="400" height="100" viewBox="0 0 400 100">
                    <line x1="50" y1="60" x2="350" y2="60" stroke="#2563eb" stroke-width="4"/>
                    <polygon points="50,60 40,80 60,80" fill="#2563eb"/>
                    <polygon points="350,60 340,80 360,80" fill="#2563eb"/>
                    <line x1="50" y1="80" x2="360" y2="80" stroke="#94a3b8" stroke-width="1"/>
                    <!-- arrows for distributed load -->
                    <g stroke="#ef4444" stroke-width="1.5" fill="#ef4444">
                        <line x1="80" y1="20" x2="80" y2="55"/><polygon points="80,55 76,47 84,47"/>
                        <line x1="120" y1="20" x2="120" y2="55"/><polygon points="120,55 116,47 124,47"/>
                        <line x1="160" y1="20" x2="160" y2="55"/><polygon points="160,55 156,47 164,47"/>
                        <line x1="200" y1="20" x2="200" y2="55"/><polygon points="200,55 196,47 204,47"/>
                        <line x1="240" y1="20" x2="240" y2="55"/><polygon points="240,55 236,47 244,47"/>
                        <line x1="280" y1="20" x2="280" y2="55"/><polygon points="280,55 276,47 284,47"/>
                        <line x1="320" y1="20" x2="320" y2="55"/><polygon points="320,55 316,47 324,47"/>
                    </g>
                    <line x1="75" y1="17" x2="325" y2="17" stroke="#ef4444" stroke-width="1.5"/>
                    <text x="200" y="12" text-anchor="middle" fill="#ef4444" font-size="12">w (kN/m)</text>
                    <text x="200" y="96" text-anchor="middle" fill="#64748b" font-size="12">L</text>
                </svg>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>跨距 L <span>(m)</span></label>
                    <input type="number" id="beam-L" value="6" step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label>均佈載重 w <span>(kN/m)</span></label>
                    <input type="number" id="beam-w" value="10" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>彈性模數 E <span>(GPa)</span></label>
                    <input type="number" id="beam-E" value="200" step="1" min="1">
                </div>
                <div class="form-group">
                    <label>慣性矩 I <span>(cm⁴)</span></label>
                    <input type="number" id="beam-I" value="8356" step="1" min="1">
                </div>
            </div>
            <button class="btn" onclick="calcBeam()">計算</button>
            <div class="result-box" id="result-beam">
                <h3>計算結果</h3>
                <div id="result-beam-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== 柱載重 ==================== -->
    <div class="tab-content" id="tab-column">
        <div class="card">
            <h2>柱軸壓載重分析</h2>
            <p class="subtitle">Euler 挫屈載重 & 容許軸壓力計算</p>
            <div class="formula-display">
                P_cr = &pi;&sup2;EI / (KL)&sup2; &nbsp;&nbsp;|&nbsp;&nbsp; &sigma; = P / A
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>彈性模數 E <span>(GPa)</span></label>
                    <input type="number" id="col-E" value="200" step="1">
                </div>
                <div class="form-group">
                    <label>慣性矩 I <span>(cm⁴)</span></label>
                    <input type="number" id="col-I" value="5696" step="1">
                </div>
                <div class="form-group">
                    <label>斷面積 A <span>(cm&sup2;)</span></label>
                    <input type="number" id="col-A" value="76.4" step="0.1">
                </div>
                <div class="form-group">
                    <label>柱長度 L <span>(m)</span></label>
                    <input type="number" id="col-L" value="4" step="0.1">
                </div>
                <div class="form-group">
                    <label>有效長度係數 K</label>
                    <select id="col-K">
                        <option value="0.5">0.5 - 兩端固定</option>
                        <option value="0.7">0.7 - 一端固定一端鉸</option>
                        <option value="1.0" selected>1.0 - 兩端鉸接</option>
                        <option value="2.0">2.0 - 一端固定一端自由</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>軸壓力 P <span>(kN)</span></label>
                    <input type="number" id="col-P" value="500" step="1">
                </div>
            </div>
            <button class="btn" onclick="calcColumn()">計算</button>
            <div class="result-box" id="result-column">
                <h3>計算結果</h3>
                <div id="result-column-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== 混凝土用量 ==================== -->
    <div class="tab-content" id="tab-concrete">
        <div class="card">
            <h2>混凝土用量估算</h2>
            <p class="subtitle">依據構件尺寸計算混凝土體積、重量及預拌車數</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>構件類型</label>
                    <select id="conc-type" onchange="toggleConcShape()">
                        <option value="rect">矩形 (板/梁/牆/基礎)</option>
                        <option value="cylinder">圓柱</option>
                    </select>
                </div>
                <div class="form-group" id="conc-w-group">
                    <label>寬度 <span>(m)</span></label>
                    <input type="number" id="conc-w" value="0.4" step="0.01">
                </div>
                <div class="form-group" id="conc-d-group" style="display:none;">
                    <label>直徑 <span>(m)</span></label>
                    <input type="number" id="conc-d" value="0.6" step="0.01">
                </div>
                <div class="form-group">
                    <label>高度/深度 <span>(m)</span></label>
                    <input type="number" id="conc-h" value="0.6" step="0.01">
                </div>
                <div class="form-group">
                    <label>長度 <span>(m)</span></label>
                    <input type="number" id="conc-l" value="8" step="0.1">
                </div>
                <div class="form-group">
                    <label>數量 <span>(支/片)</span></label>
                    <input type="number" id="conc-n" value="1" step="1" min="1">
                </div>
                <div class="form-group">
                    <label>損耗率 <span>(%)</span></label>
                    <input type="number" id="conc-loss" value="5" step="1" min="0">
                </div>
            </div>
            <button class="btn" onclick="calcConcrete()">計算</button>
            <div class="result-box" id="result-concrete">
                <h3>計算結果</h3>
                <div id="result-concrete-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== 鋼筋計算 ==================== -->
    <div class="tab-content" id="tab-rebar">
        <div class="card">
            <h2>鋼筋數量與重量計算</h2>
            <p class="subtitle">依據鋼筋號數計算單位重量、總重量</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>鋼筋號數</label>
                    <select id="rebar-no">
                        <option value="3">D10 (#3) - 0.560 kg/m</option>
                        <option value="4" selected>D13 (#4) - 0.994 kg/m</option>
                        <option value="5">D16 (#5) - 1.552 kg/m</option>
                        <option value="6">D19 (#6) - 2.235 kg/m</option>
                        <option value="7">D22 (#7) - 2.985 kg/m</option>
                        <option value="8">D25 (#8) - 3.980 kg/m</option>
                        <option value="9">D29 (#9) - 5.080 kg/m</option>
                        <option value="10">D32 (#10) - 6.390 kg/m</option>
                        <option value="11">D36 (#11) - 7.900 kg/m</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>單支長度 <span>(m)</span></label>
                    <input type="number" id="rebar-len" value="6" step="0.1">
                </div>
                <div class="form-group">
                    <label>支數</label>
                    <input type="number" id="rebar-qty" value="20" step="1" min="1">
                </div>
                <div class="form-group">
                    <label>搭接率 <span>(%)</span></label>
                    <input type="number" id="rebar-lap" value="10" step="1" min="0">
                </div>
            </div>
            <button class="btn" onclick="calcRebar()">計算</button>
            <div class="result-box" id="result-rebar">
                <h3>計算結果</h3>
                <div id="result-rebar-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== RC梁設計 ==================== -->
    <div class="tab-content" id="tab-rcbeam">
        <div class="card">
            <h2>RC梁撓曲設計 (ACI 318)</h2>
            <p class="subtitle">單筋矩形梁 - 依設計彎矩求所需鋼筋量</p>
            <div class="formula-display">
                &phi;Mn &ge; Mu &nbsp;&nbsp;|&nbsp;&nbsp; a = As&middot;fy / (0.85&middot;f'c&middot;b) &nbsp;&nbsp;|&nbsp;&nbsp; Mn = As&middot;fy&middot;(d - a/2)
            </div>
            <div class="diagram-container">
                <svg width="360" height="180" viewBox="0 0 360 180">
                    <!-- beam cross section -->
                    <rect x="80" y="10" width="100" height="160" fill="none" stroke="#2563eb" stroke-width="2"/>
                    <!-- concrete fill -->
                    <rect x="80" y="10" width="100" height="160" fill="#e0e7ff" opacity="0.5"/>
                    <!-- rebar circles -->
                    <circle cx="105" cy="145" r="6" fill="#ef4444"/>
                    <circle cx="130" cy="145" r="6" fill="#ef4444"/>
                    <circle cx="155" cy="145" r="6" fill="#ef4444"/>
                    <!-- dimensions: b -->
                    <line x1="80" y1="178" x2="180" y2="178" stroke="#64748b" stroke-width="1"/>
                    <line x1="80" y1="174" x2="80" y2="178" stroke="#64748b" stroke-width="1"/>
                    <line x1="180" y1="174" x2="180" y2="178" stroke="#64748b" stroke-width="1"/>
                    <text x="130" y="176" text-anchor="middle" fill="#64748b" font-size="11">b</text>
                    <!-- dimensions: h -->
                    <line x1="72" y1="10" x2="72" y2="170" stroke="#64748b" stroke-width="1"/>
                    <line x1="68" y1="10" x2="76" y2="10" stroke="#64748b" stroke-width="1"/>
                    <line x1="68" y1="170" x2="76" y2="170" stroke="#64748b" stroke-width="1"/>
                    <text x="64" y="94" text-anchor="middle" fill="#64748b" font-size="11" transform="rotate(-90,64,94)">h</text>
                    <!-- dimensions: d -->
                    <line x1="188" y1="10" x2="188" y2="145" stroke="#ef4444" stroke-width="1" stroke-dasharray="4"/>
                    <line x1="184" y1="10" x2="192" y2="10" stroke="#ef4444" stroke-width="1"/>
                    <line x1="184" y1="145" x2="192" y2="145" stroke="#ef4444" stroke-width="1"/>
                    <text x="198" y="82" fill="#ef4444" font-size="11">d</text>
                    <!-- stress block -->
                    <rect x="230" y="10" width="60" height="50" fill="#3b82f6" opacity="0.3" stroke="#2563eb" stroke-width="1"/>
                    <text x="260" y="38" text-anchor="middle" fill="#2563eb" font-size="10">0.85f'c</text>
                    <text x="260" y="68" text-anchor="middle" fill="#2563eb" font-size="10">a</text>
                    <!-- arrow a -->
                    <line x1="295" y1="10" x2="295" y2="60" stroke="#2563eb" stroke-width="1"/>
                    <polygon points="295,10 292,18 298,18" fill="#2563eb"/>
                    <polygon points="295,60 292,52 298,52" fill="#2563eb"/>
                    <!-- tension force -->
                    <line x1="260" y1="145" x2="260" y2="145" stroke="#ef4444" stroke-width="1"/>
                    <text x="260" y="150" text-anchor="middle" fill="#ef4444" font-size="10">As&middot;fy</text>
                </svg>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>梁寬 b <span>(cm)</span></label>
                    <input type="number" id="rc-b" value="30" step="1" min="1">
                </div>
                <div class="form-group">
                    <label>梁深 h <span>(cm)</span></label>
                    <input type="number" id="rc-h" value="60" step="1" min="1">
                </div>
                <div class="form-group">
                    <label>有效深度 d <span>(cm)</span></label>
                    <input type="number" id="rc-d" value="54" step="0.5" min="1">
                </div>
                <div class="form-group">
                    <label>混凝土強度 f'c <span>(kgf/cm&sup2;)</span></label>
                    <input type="number" id="rc-fc" value="280" step="10" min="1">
                </div>
                <div class="form-group">
                    <label>鋼筋降伏強度 fy <span>(kgf/cm&sup2;)</span></label>
                    <input type="number" id="rc-fy" value="4200" step="100" min="1">
                </div>
                <div class="form-group">
                    <label>設計彎矩 Mu <span>(tf&middot;m)</span></label>
                    <input type="number" id="rc-Mu" value="15" step="0.5" min="0">
                </div>
                <div class="form-group">
                    <label>強度折減係數 &phi;</label>
                    <input type="number" id="rc-phi" value="0.9" step="0.05" min="0.1" max="1">
                </div>
            </div>
            <button class="btn" onclick="calcRCBeam()">設計計算</button>
            <div class="result-box" id="result-rcbeam">
                <h3>設計結果</h3>
                <div id="result-rcbeam-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== RC柱設計 ==================== -->
    <div class="tab-content" id="tab-rccolumn">
        <div class="card">
            <h2>RC柱設計 (P-Mx-My 交互作用)</h2>
            <p class="subtitle">任意形狀斷面 - 雙向軸力與彎矩交互作用分析</p>

            <!-- A. 斷面幾何 -->
            <div class="section-block">
                <h3>A. 斷面幾何</h3>
                <div class="inline-controls">
                    <label style="font-size:0.85rem;font-weight:600;">預設形狀：</label>
                    <select id="rcc-preset" onchange="onPresetChange(this.value)" style="padding:0.4rem 0.6rem;border:2px solid var(--border);border-radius:6px;font-size:0.85rem;">
                        <option value="">-- 自選 --</option>
                        <option value="rect">矩形</option>
                        <option value="circle">圓形</option>
                        <option value="tshape">T型</option>
                        <option value="lshape">L型</option>
                    </select>
                </div>

                <!-- 參數化輸入 -->
                <div id="rcc-shape-params" class="form-grid" style="margin:0.5rem 0;display:none;"></div>

                <!-- 外輪廓 -->
                <p style="font-size:0.9rem;font-weight:600;margin:0.5rem 0 0.25rem;">外輪廓頂點 (cm)</p>
                <table class="coord-table" id="rcc-outer-table">
                    <thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead>
                    <tbody id="rcc-outer-body"></tbody>
                </table>
                <div>
                    <button class="btn-sm btn-sm-primary" onclick="addOuterPt()">+ 新增點</button>
                    <button class="btn-sm btn-sm-danger" onclick="removeOuterPt()">- 刪除最後一點</button>
                </div>

                <!-- 空心輪廓 -->
                <div class="inline-controls" style="margin-top:0.75rem;">
                    <label style="font-size:0.85rem;font-weight:600;">空心類型：</label>
                    <select id="rcc-hollow-preset" onchange="onHollowPresetChange(this.value)" style="padding:0.4rem 0.6rem;border:2px solid var(--border);border-radius:6px;font-size:0.85rem;">
                        <option value="none">無空心</option>
                        <option value="rect">空心矩形</option>
                        <option value="circle">空心圓形</option>
                        <option value="custom">自訂頂點</option>
                    </select>
                </div>
                <div id="rcc-hollow-params" class="form-grid" style="margin:0.5rem 0;display:none;"></div>
                <div id="rcc-hollow-custom" style="display:none;">
                    <p style="font-size:0.9rem;font-weight:600;margin:0.5rem 0 0.25rem;">空心區域頂點 (cm)</p>
                    <table class="coord-table" id="rcc-hollow-table">
                        <thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead>
                        <tbody id="rcc-hollow-body"></tbody>
                    </table>
                    <div>
                        <button class="btn-sm btn-sm-primary" onclick="addHollowPt()">+ 新增點</button>
                        <button class="btn-sm btn-sm-danger" onclick="removeHollowPt()">- 刪除最後一點</button>
                    </div>
                </div>
            </div>

            <!-- B. 斷面預覽 -->
            <div class="section-block">
                <h3>B. 斷面預覽</h3>
                <div class="preview-container" id="rcc-preview">
                    <svg id="rcc-svg" width="400" height="400" viewBox="0 0 400 400">
                        <text x="200" y="200" text-anchor="middle" fill="#94a3b8" font-size="14">尚無斷面資料</text>
                    </svg>
                </div>
            </div>

            <!-- C. 鋼筋配置 -->
            <div class="section-block">
                <h3>C. 鋼筋配置</h3>
                <div class="form-grid" style="margin-bottom:1rem;">
                    <div class="form-group">
                        <label>最小鋼筋間距 <span>(cm)</span></label>
                        <input type="number" id="rcc-spacing" value="15" step="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>單支鋼筋面積 <span>(cm²)</span></label>
                        <input type="number" id="rcc-barArea" value="5.07" step="0.01" min="0.1">
                    </div>
                </div>
                <table class="coord-table" id="rcc-rebar-table">
                    <thead><tr><th>#</th><th>X (cm)</th><th>Y (cm)</th><th>號數</th><th>面積 (cm²)</th></tr></thead>
                    <tbody id="rcc-rebar-body"></tbody>
                </table>
                <div>
                    <button class="btn-sm btn-sm-primary" onclick="addRebar()">+ 新增鋼筋</button>
                    <button class="btn-sm btn-sm-danger" onclick="removeRebar()">- 刪除最後一根</button>
                    <button class="btn-sm btn-sm-secondary" onclick="autoArrangeRebar()">自動排列</button>
                </div>
            </div>

            <!-- D. 材料參數 -->
            <div class="section-block">
                <h3>D. 材料參數</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>混凝土強度 f'c <span>(kgf/cm²)</span></label>
                        <input type="number" id="rcc-fc" value="280" step="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>鋼筋降伏強度 fy <span>(kgf/cm²)</span></label>
                        <input type="number" id="rcc-fy" value="4200" step="100" min="1">
                    </div>
                    <div class="form-group">
                        <label>鋼筋彈性模數 Es <span>(kgf/cm²)</span></label>
                        <input type="number" id="rcc-Es" value="2040000" step="10000" min="1">
                    </div>
                </div>
            </div>

            <!-- E. 載重條件 -->
            <div class="section-block">
                <h3>E. 載重條件</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>設計軸力 Pu <span>(tf)</span></label>
                        <input type="number" id="rcc-Pu" value="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>X向設計彎矩 Mux <span>(tf·m)</span></label>
                        <input type="number" id="rcc-Mux" value="5" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Y向設計彎矩 Muy <span>(tf·m)</span></label>
                        <input type="number" id="rcc-Muy" value="3" step="0.5">
                    </div>
                </div>
            </div>

            <!-- F. 設計參數 -->
            <div class="section-block">
                <h3>F. 設計參數</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>強度折減係數 φ</label>
                        <input type="number" id="rcc-phi" value="0.65" step="0.05" min="0.1" max="1">
                    </div>
                    <div class="form-group">
                        <label>保護層厚度 ic <span>(cm)</span></label>
                        <input type="number" id="rcc-ic" value="4" step="0.5" min="1" onchange="updateCover()">
                    </div>
                    <div class="form-group">
                        <label>箍筋號數</label>
                        <select id="rcc-stirrup" onchange="updateCover()">
                            <option value="3">#3 (D10)</option>
                            <option value="4" selected>#4 (D13)</option>
                            <option value="5">#5 (D16)</option>
                            <option value="6">#6 (D19)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>鋼筋中心至外緣 <span>(cm)</span></label>
                        <input type="number" id="rcc-cover" value="5.27" step="0.01" readonly style="background:#f1f5f9;">
                    </div>
                </div>
            </div>

            <button class="btn" onclick="calcRCColumn()">設計計算</button>
            <div class="result-box" id="result-rccolumn">
                <h3>設計結果</h3>
                <div id="result-rccolumn-content"></div>
            </div>
        </div>
    </div>

    <!-- ==================== 單位換算 ==================== -->
    <div class="tab-content" id="tab-unit">
        <div class="card">
            <h2>工程單位換算</h2>
            <p class="subtitle">常用工程單位快速換算</p>
            <div class="form-grid">
                <div class="form-group">
                    <label>換算類別</label>
                    <select id="unit-cat" onchange="updateUnitOptions()">
                        <option value="length">長度</option>
                        <option value="area">面積</option>
                        <option value="volume">體積</option>
                        <option value="force">力</option>
                        <option value="pressure">壓力</option>
                        <option value="moment">彎矩</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>數值</label>
                    <input type="number" id="unit-val" value="1" step="any">
                </div>
                <div class="form-group">
                    <label>從</label>
                    <select id="unit-from"></select>
                </div>
                <div class="form-group">
                    <label>到</label>
                    <select id="unit-to"></select>
                </div>
            </div>
            <button class="btn" onclick="calcUnit()">換算</button>
            <div class="result-box" id="result-unit">
                <h3>換算結果</h3>
                <div id="result-unit-content"></div>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>工程試算工具 &copy; 2026 | 僅供參考，實際工程設計請依規範辦理</p>
</footer>

<script>
// ===== Tab Switching =====
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// ===== Helpers =====
function val(id) { return parseFloat(document.getElementById(id).value) || 0; }
function sel(id) { return document.getElementById(id).value; }

function showResult(id, items) {
    const box = document.getElementById('result-' + id);
    const content = document.getElementById('result-' + id + '-content');
    content.innerHTML = items.map(([label, value]) =>
        `<div class="result-item"><span class="label">${label}</span><span class="value">${value}</span></div>`
    ).join('');
    box.classList.add('show');
}

function fmt(n, d = 4) {
    if (Math.abs(n) >= 1e6 || (Math.abs(n) < 0.001 && n !== 0)) return n.toExponential(d);
    return parseFloat(n.toFixed(d)).toLocaleString('en-US', { maximumFractionDigits: d });
}

// ===== SI 轉換因子 (所有單位 → SI 基準) =====
const factorsToSI = {
    // Force → N
    'N': 1, 'kN': 1e3, 'kgf': 9.80665, 'tf': 9806.65, 'lbf': 4.44822,
    // Length → m
    'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254,
    // Stress → Pa
    'Pa': 1, 'kPa': 1e3, 'MPa': 1e6, 'GPa': 1e9,
    'kN/m\u00B2': 1e3, 'kgf/cm\u00B2': 98066.5, 'tf/m\u00B2': 9806.65,
    'N/mm\u00B2': 1e6, 'tf/cm\u00B2': 98066500, 'kgf/m\u00B2': 9.80665,
    'ksi': 6894760, 'psi': 6894.76,
    // Moment → N·m
    'kN\u00B7m': 1e3, 'N\u00B7m': 1, 'kgf\u00B7cm': 0.0980665,
    'tf\u00B7m': 9806.65, 'N\u00B7mm': 0.001, 'tf\u00B7cm': 98.0665,
    'kgf\u00B7m': 9.80665, 'lbf\u00B7ft': 1.35582,
    // Distributed load → N/m
    'kN/m': 1e3, 'N/m': 1, 'kgf/cm': 980.665, 'tf/m': 9806.65,
    'N/mm': 1e3, 'tf/cm': 980665, 'kgf/m': 9.80665, 'lbf/ft': 14.5939,
    // Area → m²
    'm\u00B2': 1, 'cm\u00B2': 1e-4, 'mm\u00B2': 1e-6, 'in\u00B2': 6.4516e-4,
    // Inertia → m⁴
    'm\u2074': 1, 'cm\u2074': 1e-8, 'mm\u2074': 1e-12, 'in\u2074': 4.162314e-7,
    // Unit weight → N/m³
    'kN/m\u00B3': 1e3, 'kgf/cm\u00B3': 9806650, 'tf/m\u00B3': 9806.65,
    'N/mm\u00B3': 1e9, 'tf/cm\u00B3': 9.80665e9, 'kgf/m\u00B3': 9.80665, 'pcf': 157.087,
};

// ===== 單位制定義 =====
const unitSystemDefs = {
    'kN-m':   { length:'m',  force:'kN',  stress:'kN/m\u00B2',   load:'kN/m',   area:'m\u00B2',  inertia:'m\u2074',  unitweight:'kN/m\u00B3',  moment:'kN\u00B7m' },
    'kgf-cm': { length:'cm', force:'kgf', stress:'kgf/cm\u00B2', load:'kgf/cm', area:'cm\u00B2', inertia:'cm\u2074', unitweight:'kgf/cm\u00B3', moment:'kgf\u00B7cm' },
    'tf-m':   { length:'m',  force:'tf',  stress:'tf/m\u00B2',   load:'tf/m',   area:'m\u00B2',  inertia:'m\u2074',  unitweight:'tf/m\u00B3',  moment:'tf\u00B7m' },
    'N-mm':   { length:'mm', force:'N',   stress:'N/mm\u00B2',   load:'N/mm',   area:'mm\u00B2', inertia:'mm\u2074', unitweight:'N/mm\u00B3',  moment:'N\u00B7mm' },
    'tf-cm':  { length:'cm', force:'tf',  stress:'tf/cm\u00B2',  load:'tf/cm',  area:'cm\u00B2', inertia:'cm\u2074', unitweight:'tf/cm\u00B3', moment:'tf\u00B7cm' },
    'kgf-m':  { length:'m',  force:'kgf', stress:'kgf/m\u00B2',  load:'kgf/m',  area:'m\u00B2',  inertia:'m\u2074',  unitweight:'kgf/m\u00B3', moment:'kgf\u00B7m' },
};

// ===== 單位定義 (含維度類型) =====
const fieldUnits = {
    // -- 梁分析 --
    'beam-L':  { dflt: 'm',    dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254 } },
    'beam-w':  { dflt: 'kN/m', dim: 'load',   units: { 'kN/m': 1, 'kgf/cm': 0.980665, 'tf/m': 9.80665, 'N/mm': 1, 'tf/cm': 980.665, 'kgf/m': 0.00980665, 'N/m': 0.001, 'lbf/ft': 0.0145939 } },
    'beam-E':  { dflt: 'GPa',  dim: 'stress', units: { 'GPa': 1e6, 'MPa': 1e3, 'kN/m\u00B2': 1, 'kgf/cm\u00B2': 98.0665, 'tf/m\u00B2': 9.80665, 'N/mm\u00B2': 1e3, 'tf/cm\u00B2': 98066.5, 'kgf/m\u00B2': 0.00980665, 'ksi': 6.89476e3 } },
    'beam-I':  { dflt: 'cm\u2074', dim: 'inertia', units: { 'm\u2074': 1, 'cm\u2074': 1e-8, 'mm\u2074': 1e-12, 'in\u2074': 4.162314e-7 } },

    // -- 柱載重 --
    'col-E':   { dflt: 'GPa',  dim: 'stress', units: { 'GPa': 1e6, 'MPa': 1e3, 'kN/m\u00B2': 1, 'kgf/cm\u00B2': 98.0665, 'tf/m\u00B2': 9.80665, 'N/mm\u00B2': 1e3, 'tf/cm\u00B2': 98066.5, 'kgf/m\u00B2': 0.00980665, 'ksi': 6.89476e3 } },
    'col-I':   { dflt: 'cm\u2074', dim: 'inertia', units: { 'm\u2074': 1, 'cm\u2074': 1e-8, 'mm\u2074': 1e-12, 'in\u2074': 4.162314e-7 } },
    'col-A':   { dflt: 'cm\u00B2', dim: 'area', units: { 'm\u00B2': 1, 'cm\u00B2': 1e-4, 'mm\u00B2': 1e-6, 'in\u00B2': 6.4516e-4 } },
    'col-L':   { dflt: 'm',    dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048 } },
    'col-P':   { dflt: 'kN',   dim: 'force', units: { 'kN': 1, 'N': 0.001, 'kgf': 0.00980665, 'tf': 9.80665, 'lbf': 0.00444822 } },

    // -- 混凝土 --
    'conc-w':  { dflt: 'm', dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254 } },
    'conc-d':  { dflt: 'm', dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254 } },
    'conc-h':  { dflt: 'm', dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254 } },
    'conc-l':  { dflt: 'm', dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254 } },

    // -- 鋼筋 --
    'rebar-len': { dflt: 'm', dim: 'length', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048 } },

    // -- RC梁設計 --
    'rc-b':  { dflt: 'cm', dim: 'length', units: { 'cm': 1, 'mm': 0.1, 'm': 100, 'in': 2.54 } },
    'rc-h':  { dflt: 'cm', dim: 'length', units: { 'cm': 1, 'mm': 0.1, 'm': 100, 'in': 2.54 } },
    'rc-d':  { dflt: 'cm', dim: 'length', units: { 'cm': 1, 'mm': 0.1, 'm': 100, 'in': 2.54 } },
    'rc-fc': { dflt: 'kgf/cm\u00B2', dim: 'stress', units: { 'kgf/cm\u00B2': 1, 'MPa': 10.1972, 'N/mm\u00B2': 10.1972, 'tf/m\u00B2': 1e4, 'kN/m\u00B2': 0.0101972, 'psi': 0.070307 } },
    'rc-fy': { dflt: 'kgf/cm\u00B2', dim: 'stress', units: { 'kgf/cm\u00B2': 1, 'MPa': 10.1972, 'N/mm\u00B2': 10.1972, 'tf/m\u00B2': 1e4, 'kN/m\u00B2': 0.0101972, 'psi': 0.070307 } },
    'rc-Mu': { dflt: 'tf\u00B7m', dim: 'moment', units: { 'tf\u00B7m': 1, 'kN\u00B7m': 0.101972, 'kgf\u00B7cm': 1e5, 'kgf\u00B7m': 1e3, 'N\u00B7mm': 1.01972e-7, 'tf\u00B7cm': 100, 'N\u00B7m': 1.01972e-4 } },

    // -- RC柱設計 --
    'rcc-fc':  { dflt: 'kgf/cm\u00B2', dim: 'stress', units: { 'kgf/cm\u00B2': 1, 'MPa': 10.1972, 'N/mm\u00B2': 10.1972, 'tf/m\u00B2': 1e4, 'kN/m\u00B2': 0.0101972, 'psi': 0.070307 } },
    'rcc-fy':  { dflt: 'kgf/cm\u00B2', dim: 'stress', units: { 'kgf/cm\u00B2': 1, 'MPa': 10.1972, 'N/mm\u00B2': 10.1972, 'tf/m\u00B2': 1e4, 'kN/m\u00B2': 0.0101972, 'psi': 0.070307 } },
    'rcc-Es':  { dflt: 'kgf/cm\u00B2', dim: 'stress', units: { 'kgf/cm\u00B2': 1, 'MPa': 10.1972, 'N/mm\u00B2': 10.1972, 'tf/m\u00B2': 1e4, 'kN/m\u00B2': 0.0101972, 'psi': 0.070307 } },
    'rcc-Pu':  { dflt: 'tf', dim: 'force', units: { 'tf': 1, 'kN': 0.101972, 'kgf': 1e3, 'N': 0.000101972, 'lbf': 0.000453592 } },
    'rcc-Mux': { dflt: 'tf\u00B7m', dim: 'moment', units: { 'tf\u00B7m': 1, 'kN\u00B7m': 0.101972, 'kgf\u00B7cm': 1e5, 'kgf\u00B7m': 1e3, 'tf\u00B7cm': 100, 'N\u00B7m': 1.01972e-4 } },
    'rcc-Muy': { dflt: 'tf\u00B7m', dim: 'moment', units: { 'tf\u00B7m': 1, 'kN\u00B7m': 0.101972, 'kgf\u00B7cm': 1e5, 'kgf\u00B7m': 1e3, 'tf\u00B7cm': 100, 'N\u00B7m': 1.01972e-4 } },
    'rcc-ic': { dflt: 'cm', dim: 'length', units: { 'cm': 1, 'mm': 0.1, 'm': 100, 'in': 2.54 } },
    'rcc-spacing': { dflt: 'cm', dim: 'length', units: { 'cm': 1, 'mm': 0.1, 'm': 100, 'in': 2.54 } },
    'rcc-barArea': { dflt: 'cm²', dim: 'area', units: { 'cm²': 1, 'mm²': 0.01, 'in²': 6.4516 } },
};

// 讀取數值並轉換到基準單位
function valU(id) {
    const v = parseFloat(document.getElementById(id).value) || 0;
    const fu = fieldUnits[id];
    if (!fu) return v;
    const unitSel = document.getElementById(id + '-unit');
    if (!unitSel) return v;
    const factor = fu.units[unitSel.value] || 1;
    return v * factor;
}

// 動態建立單位選擇器
function initUnitSelectors() {
    for (const [id, cfg] of Object.entries(fieldUnits)) {
        const input = document.getElementById(id);
        if (!input) continue;

        // 移除 label 中的單位提示 <span>
        const label = input.closest('.form-group').querySelector('label span');
        if (label) label.remove();

        // 建立 unit select
        const select = document.createElement('select');
        select.id = id + '-unit';
        select.className = 'unit-select';
        for (const [uName] of Object.entries(cfg.units)) {
            const opt = document.createElement('option');
            opt.value = uName;
            opt.textContent = uName;
            if (uName === cfg.dflt) opt.selected = true;
            select.appendChild(opt);
        }

        // 包裝 input + select
        const wrapper = document.createElement('div');
        wrapper.className = 'input-unit-group';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        wrapper.appendChild(select);
    }
}

// ===== 全域單位制切換 =====
function switchUnitSystem(system) {
    if (!system) return;
    const sysDef = unitSystemDefs[system];
    if (!sysDef) return;

    for (const [fieldId, cfg] of Object.entries(fieldUnits)) {
        if (!cfg.dim) continue;
        const targetUnit = sysDef[cfg.dim];
        if (!targetUnit) continue;
        if (!cfg.units[targetUnit]) continue;

        const input = document.getElementById(fieldId);
        const unitSel = document.getElementById(fieldId + '-unit');
        if (!input || !unitSel) continue;

        const currentUnit = unitSel.value;
        if (currentUnit === targetUnit) continue;

        const oldFactor = cfg.units[currentUnit] || 1;
        const newFactor = cfg.units[targetUnit] || 1;
        const currentVal = parseFloat(input.value) || 0;
        const newVal = currentVal * oldFactor / newFactor;

        input.value = parseFloat(newVal.toPrecision(6));
        unitSel.value = targetUnit;
    }
}

// ===== 計算結果單位轉換 =====
function resultInSystem(value, fromUnit, dim) {
    const sys = document.getElementById('unit-system').value;
    if (!sys) return { v: value, u: fromUnit };
    const sysDef = unitSystemDefs[sys];
    const toUnit = sysDef[dim];
    if (!toUnit || toUnit === fromUnit) return { v: value, u: fromUnit };
    const fromF = factorsToSI[fromUnit];
    const toF = factorsToSI[toUnit];
    if (!fromF || !toF) return { v: value, u: fromUnit };
    return { v: value * fromF / toF, u: toUnit };
}

// ===== 梁分析 =====
function calcBeam() {
    const L = valU('beam-L'), w = valU('beam-w');
    const E = valU('beam-E');
    const I = valU('beam-I');
    const Mmax = w * L * L / 8;
    const Vmax = w * L / 2;
    const delta = (5 * w * Math.pow(L, 4)) / (384 * E * I) * 1000; // mm
    const Rmax = w * L / 2;

    const rM = resultInSystem(Mmax, 'kN\u00B7m', 'moment');
    const rV = resultInSystem(Vmax, 'kN', 'force');
    const rR = resultInSystem(Rmax, 'kN', 'force');
    const rD = resultInSystem(delta, 'mm', 'length');

    showResult('beam', [
        ['\u6700\u5927\u5F4E\u77E9 M_max', fmt(rM.v, 2) + ' ' + rM.u],
        ['\u6700\u5927\u526A\u529B V_max', fmt(rV.v, 2) + ' ' + rV.u],
        ['\u652F\u627F\u53CD\u529B R', fmt(rR.v, 2) + ' ' + rR.u],
        ['\u6700\u5927\u6493\u5EA6 \u03B4_max', fmt(rD.v, 3) + ' ' + rD.u],
        ['\u6493\u5EA6\u6BD4 L/\u03B4', 'L/' + fmt(L * 1000 / delta, 0)],
    ]);
}

// ===== 柱載重 =====
function calcColumn() {
    const E = valU('col-E');
    const I = valU('col-I');
    const A = valU('col-A');
    const L = valU('col-L');
    const K = parseFloat(sel('col-K'));
    const P = valU('col-P');
    const Pcr = Math.PI * Math.PI * E * I / Math.pow(K * L, 2);
    const sigma = P / A; // kN/m²
    const sigmaMPa = sigma / 1000;
    const r = Math.sqrt(I / A);
    const slenderness = K * L / r;
    const fs = Pcr / P;

    const rPcr = resultInSystem(Pcr, 'kN', 'force');
    const rSigma = resultInSystem(sigmaMPa, 'MPa', 'stress');
    const rR = resultInSystem(r * 100, 'cm', 'length');

    showResult('column', [
        ['Euler \u631C\u5C48\u8F09\u91CD P_cr', fmt(rPcr.v, 1) + ' ' + rPcr.u],
        ['\u8EF8\u58D3\u61C9\u529B \u03C3', fmt(rSigma.v, 2) + ' ' + rSigma.u],
        ['\u8FF4\u8F49\u534A\u5F91 r', fmt(rR.v, 2) + ' ' + rR.u],
        ['\u7D30\u9577\u6BD4 KL/r', fmt(slenderness, 1)],
        ['\u5B89\u5168\u4FC2\u6578 P_cr/P', fmt(fs, 2)],
        ['\u72C0\u614B', fs >= 1.0 ? '\u2705 \u5B89\u5168' : '\u26A0\uFE0F \u8D85\u904E\u631C\u5C48\u8F09\u91CD\uFF01'],
    ]);
}

// ===== 混凝土用量 =====
function toggleConcShape() {
    const t = sel('conc-type');
    document.getElementById('conc-w-group').style.display = t === 'rect' ? '' : 'none';
    document.getElementById('conc-d-group').style.display = t === 'cylinder' ? '' : 'none';
}

function calcConcrete() {
    const type = sel('conc-type');
    const h = valU('conc-h'), l = valU('conc-l'), n = val('conc-n'), loss = val('conc-loss');
    let vol;
    if (type === 'rect') {
        const w = valU('conc-w');
        vol = w * h * l;
    } else {
        const d = valU('conc-d');
        vol = Math.PI * Math.pow(d / 2, 2) * l;
    }
    const totalVol = vol * n;
    const withLoss = totalVol * (1 + loss / 100);
    const weight = withLoss * 2400;
    const trucks = Math.ceil(withLoss / 9);
    showResult('concrete', [
        ['\u55AE\u652F\u9AD4\u7A4D', fmt(vol, 3) + ' m\u00B3'],
        ['\u7E3D\u9AD4\u7A4D (\u6DE8)', fmt(totalVol, 3) + ' m\u00B3'],
        ['\u542B\u640D\u8017\u9AD4\u7A4D', fmt(withLoss, 3) + ' m\u00B3'],
        ['\u9810\u4F30\u91CD\u91CF', fmt(weight, 0) + ' kg (' + fmt(weight / 1000, 2) + ' t)'],
        ['\u9810\u62CC\u8ECA\u6578 (9m\u00B3/\u8ECA)', trucks + ' \u8ECA'],
    ]);
}

// ===== 鋼筋計算 =====
function calcRebar() {
    const rebarData = {
        3: { dia: 9.53, weight: 0.560, name: 'D10 (#3)' },
        4: { dia: 12.7, weight: 0.994, name: 'D13 (#4)' },
        5: { dia: 15.9, weight: 1.552, name: 'D16 (#5)' },
        6: { dia: 19.1, weight: 2.235, name: 'D19 (#6)' },
        7: { dia: 22.2, weight: 2.985, name: 'D22 (#7)' },
        8: { dia: 25.4, weight: 3.980, name: 'D25 (#8)' },
        9: { dia: 28.7, weight: 5.080, name: 'D29 (#9)' },
        10: { dia: 32.3, weight: 6.390, name: 'D32 (#10)' },
        11: { dia: 35.8, weight: 7.900, name: 'D36 (#11)' },
    };
    const no = sel('rebar-no');
    const len = valU('rebar-len'), qty = val('rebar-qty'), lap = val('rebar-lap');
    const rb = rebarData[no];
    const totalLen = len * qty * (1 + lap / 100);
    const totalWeight = totalLen * rb.weight;
    const area = Math.PI * Math.pow(rb.dia / 2, 2);
    showResult('rebar', [
        ['\u92FC\u7B4B\u898F\u683C', rb.name],
        ['\u76F4\u5F91', rb.dia + ' mm'],
        ['\u55AE\u4F4D\u91CD', rb.weight + ' kg/m'],
        ['\u55AE\u652F\u65B7\u9762\u7A4D', fmt(area, 1) + ' mm\u00B2'],
        ['\u7E3D\u9577\u5EA6 (\u542B\u642D\u63A5)', fmt(totalLen, 2) + ' m'],
        ['\u7E3D\u91CD\u91CF', fmt(totalWeight, 1) + ' kg (' + fmt(totalWeight / 1000, 3) + ' t)'],
    ]);
}

// ===== RC梁撓曲設計 =====
function calcRCBeam() {
    // 所有計算以 kgf-cm 為基準
    const b = valU('rc-b');    // cm
    const h = valU('rc-h');    // cm
    const d = valU('rc-d');    // cm
    const fc = valU('rc-fc');  // kgf/cm²
    const fy = valU('rc-fy');  // kgf/cm²
    const Mu_tfm = valU('rc-Mu'); // tf·m
    const phi = val('rc-phi');

    // 轉換 Mu: tf·m → kgf·cm
    const Mu = Mu_tfm * 1e5; // 1 tf·m = 100000 kgf·cm

    // β1 係數 (ACI 318)
    // f'c 以 MPa 判斷: 1 kgf/cm² = 0.0980665 MPa
    const fc_MPa = fc * 0.0980665;
    let beta1;
    if (fc_MPa <= 28) {
        beta1 = 0.85;
    } else {
        beta1 = 0.85 - 0.05 * (fc_MPa - 28) / 7;
        if (beta1 < 0.65) beta1 = 0.65;
    }

    // 最大鋼筋比 (確保拉力控制, εt ≥ 0.005)
    const rho_max = 0.85 * beta1 * (fc / fy) * (0.003 / (0.003 + 0.005));

    // 最小鋼筋比 (ACI 318-14 §9.6.1.2)
    const rho_min1 = 0.8 * Math.sqrt(fc_MPa) / (fy * 0.0980665);
    const rho_min2 = 14 / fy;
    const rho_min = Math.max(rho_min1, rho_min2);

    // Rn 法求所需鋼筋量
    const Mn_req = Mu / phi; // kgf·cm
    const Rn = Mn_req / (b * d * d); // kgf/cm²

    // 檢查是否超過單筋梁容量
    const Rn_max = rho_max * fy * (1 - 0.59 * rho_max * fy / fc);

    let rho_req, As_req, a, Mn_provided;
    let status = '';
    let isOverReinforced = false;

    if (Rn > Rn_max) {
        isOverReinforced = true;
        rho_req = rho_max;
        As_req = rho_max * b * d;
        a = As_req * fy / (0.85 * fc * b);
        Mn_provided = phi * As_req * fy * (d - a / 2);
    } else {
        // ρ = (0.85 f'c / fy) × (1 - √(1 - 2Rn / (0.85 f'c)))
        const term = 2 * Rn / (0.85 * fc);
        if (term >= 1) {
            isOverReinforced = true;
            rho_req = rho_max;
        } else {
            rho_req = (0.85 * fc / fy) * (1 - Math.sqrt(1 - term));
        }
        // 檢查最小鋼筋比
        if (rho_req < rho_min) rho_req = rho_min;
        As_req = rho_req * b * d;
        a = As_req * fy / (0.85 * fc * b);
        Mn_provided = phi * As_req * fy * (d - a / 2);
    }

    // c 值與淨拉應變
    const c = a / beta1;
    const epsilon_t = 0.003 * (d - c) / c;

    // 判斷狀態
    if (isOverReinforced) {
        status = '\u26A0\uFE0F \u8D85\u904E\u55AE\u7B4B\u6881\u5BB9\u91CF\uFF0C\u9700\u63A1\u96D9\u7B4B\u6881\u6216\u52A0\u5927\u65B7\u9762';
    } else if (epsilon_t >= 0.005) {
        status = '\u2705 \u62C9\u529B\u63A7\u5236\u65B7\u9762 (\u03B5t \u2265 0.005)';
    } else if (epsilon_t >= 0.004) {
        status = '\u26A0\uFE0F \u904E\u6E21\u5340\u65B7\u9762 (0.004 \u2264 \u03B5t < 0.005)';
    } else {
        status = '\u274C \u58D3\u529B\u63A7\u5236\u65B7\u9762 (\u03B5t < 0.004)';
    }

    // 建議配筋
    const rebarOptions = [
        { no: '#4 (D13)', dia: 1.27, area: 1.267 },
        { no: '#5 (D16)', dia: 1.59, area: 1.986 },
        { no: '#6 (D19)', dia: 1.91, area: 2.865 },
        { no: '#7 (D22)', dia: 2.22, area: 3.871 },
        { no: '#8 (D25)', dia: 2.54, area: 5.067 },
        { no: '#9 (D29)', dia: 2.87, area: 6.469 },
        { no: '#10 (D32)', dia: 3.23, area: 8.143 },
    ];
    let suggestion = '';
    for (const rb of rebarOptions) {
        const nBars = Math.ceil(As_req / rb.area);
        const totalAs = nBars * rb.area;
        const clearWidth = b - 2 * 4 - 2 * 1.27; // 假設 4cm 保護層 + #4 箍筋
        const spacing = nBars > 1 ? (clearWidth - nBars * rb.dia) / (nBars - 1) : clearWidth;
        if (spacing >= 2.5 && nBars <= 8) {
            suggestion = nBars + '-' + rb.no + ' (As=' + fmt(totalAs, 2) + ' cm\u00B2)';
            break;
        }
    }
    if (!suggestion) suggestion = '\u8ACB\u8ABF\u6574\u65B7\u9762\u6216\u63A1\u7528\u96D9\u5C64\u914D\u7B4B';

    // 輸出結果 (以 tf·m 和 cm² 顯示)
    const rMu = resultInSystem(Mu_tfm, 'tf\u00B7m', 'moment');
    const rMn = resultInSystem(Mn_provided / 1e5, 'tf\u00B7m', 'moment');

    showResult('rcbeam', [
        ['\u8A2D\u8A08\u5F4E\u77E9 Mu', fmt(rMu.v, 2) + ' ' + rMu.u],
        ['\u6240\u9700\u92FC\u7B4B\u91CF As', fmt(As_req, 2) + ' cm\u00B2'],
        ['\u92FC\u7B4B\u6BD4 \u03C1', fmt(rho_req * 100, 3) + ' %'],
        ['\u6700\u5C0F\u92FC\u7B4B\u6BD4 \u03C1min', fmt(rho_min * 100, 3) + ' %'],
        ['\u6700\u5927\u92FC\u7B4B\u6BD4 \u03C1max', fmt(rho_max * 100, 3) + ' %'],
        ['\u61C9\u529B\u584A\u6DF1\u5EA6 a', fmt(a, 2) + ' cm'],
        ['\u4E2D\u6027\u8EF8\u6DF1\u5EA6 c', fmt(c, 2) + ' cm'],
        ['\u6DE8\u62C9\u61C9\u8B8A \u03B5t', fmt(epsilon_t, 4)],
        ['\u03B21', fmt(beta1, 3)],
        ['\u63D0\u4F9B\u5F4E\u77E9 \u03C6Mn', fmt(rMn.v, 2) + ' ' + rMn.u],
        ['\u5EFA\u8B70\u914D\u7B4B', suggestion],
        ['\u65B7\u9762\u72C0\u614B', status],
    ]);
}

// ===== RC柱設計 =====
const rcColData = {
    outer: [],   // [{x, y}, ...]
    hollow: [],  // [{x, y}, ...]
    rebars: [],  // [{x, y, no, area}, ...]
    pcX: null, pcY: null, alpha: null,  // 塑性中心與方位角 (計算後填入)
};

const rebarInfo = {
    0: { dia: 2, area: 0, name: '自訂' },
    3: { dia: 0.953, area: 0.7133, name: '#3 (D10)' },
    4: { dia: 1.27,  area: 1.267,  name: '#4 (D13)' },
    5: { dia: 1.59,  area: 1.986,  name: '#5 (D16)' },
    6: { dia: 1.91,  area: 2.865,  name: '#6 (D19)' },
    7: { dia: 2.22,  area: 3.871,  name: '#7 (D22)' },
    8: { dia: 2.54,  area: 5.067,  name: '#8 (D25)' },
    9: { dia: 2.87,  area: 6.469,  name: '#9 (D29)' },
    10:{ dia: 3.23,  area: 8.143,  name: '#10 (D32)' },
    11:{ dia: 3.58,  area: 10.06,  name: '#11 (D36)' },
};

function rebarSelectHTML(selected) {
    return Object.entries(rebarInfo).map(([no, info]) =>
        `<option value="${no}" ${no == selected ? 'selected' : ''}>${info.name}</option>`
    ).join('');
}

function renderOuterTable() {
    const tbody = document.getElementById('rcc-outer-body');
    tbody.innerHTML = rcColData.outer.map((pt, i) =>
        `<tr><td>${i + 1}</td><td><input type="number" value="${pt.x}" step="1" onchange="rcColData.outer[${i}].x=parseFloat(this.value)||0;drawRCColPreview()"></td><td><input type="number" value="${pt.y}" step="1" onchange="rcColData.outer[${i}].y=parseFloat(this.value)||0;drawRCColPreview()"></td></tr>`
    ).join('');
    drawRCColPreview();
}

function renderHollowTable() {
    const tbody = document.getElementById('rcc-hollow-body');
    tbody.innerHTML = rcColData.hollow.map((pt, i) =>
        `<tr><td>${i + 1}</td><td><input type="number" value="${pt.x}" step="1" onchange="rcColData.hollow[${i}].x=parseFloat(this.value)||0;drawRCColPreview()"></td><td><input type="number" value="${pt.y}" step="1" onchange="rcColData.hollow[${i}].y=parseFloat(this.value)||0;drawRCColPreview()"></td></tr>`
    ).join('');
    drawRCColPreview();
}

function onHollowPresetChange(type) {
    const paramsDiv = document.getElementById('rcc-hollow-params');
    const customDiv = document.getElementById('rcc-hollow-custom');
    if (type === 'none') {
        paramsDiv.style.display = 'none';
        paramsDiv.innerHTML = '';
        customDiv.style.display = 'none';
        rcColData.hollow = [];
        renderHollowTable();
        return;
    }
    if (type === 'custom') {
        paramsDiv.style.display = 'none';
        paramsDiv.innerHTML = '';
        customDiv.style.display = 'block';
        return;
    }
    customDiv.style.display = 'none';
    const paramDefs = {
        rect:   [{ id:'rcc-hp-Bh', label:'Bh (寬)', val:20 }, { id:'rcc-hp-Hh', label:'Hh (高)', val:30 },
                 { id:'rcc-hp-Cx', label:'Cx (中心X)', val:25 }, { id:'rcc-hp-Cy', label:'Cy (中心Y)', val:30 }],
        circle: [{ id:'rcc-hp-Rh', label:'Rh (半徑)', val:15 },
                 { id:'rcc-hp-Cx', label:'Cx (中心X)', val:25 }, { id:'rcc-hp-Cy', label:'Cy (中心Y)', val:30 }],
    };
    const defs = paramDefs[type] || [];
    paramsDiv.innerHTML = defs.map(d =>
        `<div class="form-group"><label>${d.label} <span>(cm)</span></label><input type="number" id="${d.id}" value="${d.val}" step="1" min="0" onchange="applyHollowShape('${type}')"></div>`
    ).join('');
    paramsDiv.style.display = 'grid';
    applyHollowShape(type);
}

function applyHollowShape(type) {
    switch (type) {
        case 'rect': {
            const Bh = parseFloat(document.getElementById('rcc-hp-Bh').value) || 20;
            const Hh = parseFloat(document.getElementById('rcc-hp-Hh').value) || 30;
            const cx = parseFloat(document.getElementById('rcc-hp-Cx').value) || 25;
            const cy = parseFloat(document.getElementById('rcc-hp-Cy').value) || 30;
            rcColData.hollow = [
                { x: cx - Bh/2, y: cy - Hh/2 }, { x: cx + Bh/2, y: cy - Hh/2 },
                { x: cx + Bh/2, y: cy + Hh/2 }, { x: cx - Bh/2, y: cy + Hh/2 }
            ];
            break;
        }
        case 'circle': {
            const rh = parseFloat(document.getElementById('rcc-hp-Rh').value) || 15;
            const cx = parseFloat(document.getElementById('rcc-hp-Cx').value) || 25;
            const cy = parseFloat(document.getElementById('rcc-hp-Cy').value) || 30;
            const nPts = 24;
            rcColData.hollow = [];
            for (let i = 0; i < nPts; i++) {
                const ang = (2 * Math.PI * i) / nPts;
                rcColData.hollow.push({
                    x: parseFloat((cx + rh * Math.cos(ang)).toFixed(2)),
                    y: parseFloat((cy + rh * Math.sin(ang)).toFixed(2))
                });
            }
            break;
        }
    }
    renderHollowTable();
}

function renderRebarTable() {
    const tbody = document.getElementById('rcc-rebar-body');
    tbody.innerHTML = rcColData.rebars.map((rb, i) => {
        const isCustom = rb.no === 0;
        const areaCell = isCustom
            ? `<input type="number" value="${rb.area}" step="0.01" min="0" style="width:70px" onchange="rcColData.rebars[${i}].area=parseFloat(this.value)||0;drawRCColPreview()">`
            : `<span>${rebarInfo[rb.no].area}</span>`;
        return `<tr><td>${i + 1}</td><td><input type="number" value="${rb.x}" step="0.5" onchange="rcColData.rebars[${i}].x=parseFloat(this.value)||0;drawRCColPreview()"></td><td><input type="number" value="${rb.y}" step="0.5" onchange="rcColData.rebars[${i}].y=parseFloat(this.value)||0;drawRCColPreview()"></td><td><select onchange="onRebarNoChange(${i},this.value)">${rebarSelectHTML(rb.no)}</select></td><td>${areaCell}</td></tr>`;
    }).join('');
    drawRCColPreview();
}

function onRebarNoChange(idx, val) {
    const no = parseInt(val);
    rcColData.rebars[idx].no = no;
    if (no !== 0) {
        rcColData.rebars[idx].area = rebarInfo[no].area;
    }
    renderRebarTable();
}

function addOuterPt() {
    const pts = rcColData.outer;
    rcColData.outer.push({ x: 0, y: 0 });
    renderOuterTable();
}

function removeOuterPt() {
    if (rcColData.outer.length > 0) {
        rcColData.outer.pop();
        renderOuterTable();
    }
}

function addHollowPt() {
    rcColData.hollow.push({ x: 0, y: 0 });
    renderHollowTable();
}

function removeHollowPt() {
    if (rcColData.hollow.length > 0) {
        rcColData.hollow.pop();
        renderHollowTable();
    }
}

function addRebar() {
    rcColData.rebars.push({ x: 0, y: 0, no: 8, area: rebarInfo[8].area });
    renderRebarTable();
}

function removeRebar() {
    if (rcColData.rebars.length > 0) {
        rcColData.rebars.pop();
        renderRebarTable();
    }
}

function updateCover() {
    const ic = parseFloat(document.getElementById('rcc-ic').value) || 4;
    const stirrupNo = parseInt(document.getElementById('rcc-stirrup').value) || 4;
    const db = rebarInfo[stirrupNo] ? rebarInfo[stirrupNo].dia : rebarInfo[4].dia;
    const cover = parseFloat((ic + db).toFixed(2));
    document.getElementById('rcc-cover').value = cover;
}

function onPresetChange(type) {
    const paramsDiv = document.getElementById('rcc-shape-params');
    if (!type) {
        paramsDiv.style.display = 'none';
        paramsDiv.innerHTML = '';
        return;
    }
    const paramDefs = {
        rect:   [{ id:'rcc-p-B', label:'B (寬)', val:50 }, { id:'rcc-p-H', label:'H (高)', val:60 }],
        circle: [{ id:'rcc-p-R', label:'R (半徑)', val:30 }],
        tshape: [{ id:'rcc-p-Bf', label:'Bf (翼寬)', val:80 }, { id:'rcc-p-tf', label:'tf (翼厚)', val:15 },
                 { id:'rcc-p-Bw', label:'Bw (腹寬)', val:30 }, { id:'rcc-p-H', label:'H (總高)', val:60 }],
        lshape: [{ id:'rcc-p-Bx', label:'Bx (水平)', val:60 }, { id:'rcc-p-By', label:'By (垂直)', val:60 },
                 { id:'rcc-p-tx', label:'tx (水平厚)', val:20 }, { id:'rcc-p-ty', label:'ty (垂直厚)', val:20 }],
    };
    const defs = paramDefs[type] || [];
    paramsDiv.innerHTML = defs.map(d =>
        `<div class="form-group"><label>${d.label} <span>(cm)</span></label><input type="number" id="${d.id}" value="${d.val}" step="1" min="1" onchange="applyPresetShape('${type}')"></div>`
    ).join('');
    paramsDiv.style.display = 'grid';
    applyPresetShape(type);
}

function applyPresetShape(type) {
    if (!type) return;
    rcColData.hollow = [];
    switch (type) {
        case 'rect': {
            const B = parseFloat(document.getElementById('rcc-p-B').value) || 50;
            const H = parseFloat(document.getElementById('rcc-p-H').value) || 60;
            rcColData.outer = [
                { x: 0, y: 0 }, { x: B, y: 0 },
                { x: B, y: H }, { x: 0, y: H }
            ];
            break;
        }
        case 'circle': {
            const r = parseFloat(document.getElementById('rcc-p-R').value) || 30;
            const nPts = 24;
            rcColData.outer = [];
            for (let i = 0; i < nPts; i++) {
                const ang = (2 * Math.PI * i) / nPts;
                rcColData.outer.push({
                    x: parseFloat((r + r * Math.cos(ang)).toFixed(2)),
                    y: parseFloat((r + r * Math.sin(ang)).toFixed(2))
                });
            }
            break;
        }
        case 'tshape': {
            const Bf = parseFloat(document.getElementById('rcc-p-Bf').value) || 80;
            const tf = parseFloat(document.getElementById('rcc-p-tf').value) || 15;
            const Bw = parseFloat(document.getElementById('rcc-p-Bw').value) || 30;
            const H  = parseFloat(document.getElementById('rcc-p-H').value)  || 60;
            const x1 = (Bf - Bw) / 2;
            const x2 = x1 + Bw;
            rcColData.outer = [
                { x: 0, y: 0 }, { x: Bf, y: 0 },
                { x: Bf, y: tf }, { x: x2, y: tf },
                { x: x2, y: H }, { x: x1, y: H },
                { x: x1, y: tf }, { x: 0, y: tf }
            ];
            break;
        }
        case 'lshape': {
            const Bx = parseFloat(document.getElementById('rcc-p-Bx').value) || 60;
            const By = parseFloat(document.getElementById('rcc-p-By').value) || 60;
            const tx = parseFloat(document.getElementById('rcc-p-tx').value) || 20;
            const ty = parseFloat(document.getElementById('rcc-p-ty').value) || 20;
            rcColData.outer = [
                { x: 0, y: 0 }, { x: Bx, y: 0 },
                { x: Bx, y: tx }, { x: ty, y: tx },
                { x: ty, y: By }, { x: 0, y: By }
            ];
            break;
        }
    }
    renderOuterTable();
    renderHollowTable();
}

function autoArrangeRebar() {
    const pts = rcColData.outer;
    if (pts.length < 3) return;
    const cover = parseFloat(document.getElementById('rcc-cover').value) || 4;
    const spacing = parseFloat(document.getElementById('rcc-spacing').value) || 15;
    const barArea = parseFloat(document.getElementById('rcc-barArea').value) || 5.07;

    // Inward offset polygon: move each edge inward by cover along its normal,
    // then intersect adjacent offset edges to get new vertices.
    const n = pts.length;

    // Compute inward unit normal for each edge (assumes CCW winding; auto-detect)
    // Check winding via signed area
    let signedArea2 = 0;
    for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        signedArea2 += pts[i].x * pts[j].y - pts[j].x * pts[i].y;
    }
    const windingSign = signedArea2 >= 0 ? 1 : -1; // +1 if CCW, -1 if CW

    // For each edge i→i+1, compute offset line (point + direction)
    const edges = [];
    for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        const ex = pts[j].x - pts[i].x;
        const ey = pts[j].y - pts[i].y;
        const len = Math.sqrt(ex * ex + ey * ey);
        if (len === 0) { edges.push(null); continue; }
        // Inward normal: for CCW polygon, inward normal of edge (ex,ey) is (-ey,ex) normalized
        const nx = windingSign * (-ey) / len;
        const ny = windingSign * ex / len;
        // Offset line: shift edge start/end by cover * normal
        edges.push({
            px: pts[i].x + nx * cover, py: pts[i].y + ny * cover,
            dx: ex, dy: ey
        });
    }

    // Intersect adjacent offset edges to get offset polygon vertices
    function lineIntersect(e1, e2) {
        // e1: point (px,py) + t*(dx,dy), e2: point (px,py) + s*(dx,dy)
        const det = e1.dx * e2.dy - e1.dy * e2.dx;
        if (Math.abs(det) < 1e-10) return null; // parallel
        const t = ((e2.px - e1.px) * e2.dy - (e2.py - e1.py) * e2.dx) / det;
        return { x: e1.px + t * e1.dx, y: e1.py + t * e1.dy };
    }

    const offsetPts = [];
    for (let i = 0; i < n; i++) {
        const prev = (i - 1 + n) % n;
        const e1 = edges[prev], e2 = edges[i];
        if (!e1 || !e2) { offsetPts.push({ x: pts[i].x, y: pts[i].y }); continue; }
        const pt = lineIntersect(e1, e2);
        if (!pt) { offsetPts.push({ x: pts[i].x, y: pts[i].y }); continue; }
        offsetPts.push({
            x: parseFloat(pt.x.toFixed(2)),
            y: parseFloat(pt.y.toFixed(2))
        });
    }

    // Place rebars at offset vertices + midpoints of longer edges
    rcColData.rebars = [];
    for (let i = 0; i < offsetPts.length; i++) {
        rcColData.rebars.push({ x: offsetPts[i].x, y: offsetPts[i].y, no: 0, area: barArea });
        const j = (i + 1) % offsetPts.length;
        const dx = offsetPts[j].x - offsetPts[i].x;
        const dy = offsetPts[j].y - offsetPts[i].y;
        const edgeLen = Math.sqrt(dx * dx + dy * dy);
        const nSeg = Math.floor(edgeLen / spacing);
        for (let k = 1; k < nSeg; k++) {
            rcColData.rebars.push({
                x: parseFloat((offsetPts[i].x + dx * k / nSeg).toFixed(2)),
                y: parseFloat((offsetPts[i].y + dy * k / nSeg).toFixed(2)),
                no: 0,
                area: barArea
            });
        }
    }
    renderRebarTable();
}

function drawRCColPreview() {
    const svg = document.getElementById('rcc-svg');
    const outer = rcColData.outer;
    const hollow = rcColData.hollow;
    const rebars = rcColData.rebars;

    if (outer.length < 3) {
        svg.innerHTML = '<text x="200" y="200" text-anchor="middle" fill="#94a3b8" font-size="14">請輸入至少 3 個外輪廓頂點</text>';
        return;
    }

    // Find bounding box
    let allPts = [...outer];
    if (hollow.length > 0) allPts = allPts.concat(hollow);
    rebars.forEach(r => allPts.push({ x: r.x, y: r.y }));

    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    allPts.forEach(p => {
        if (p.x < minX) minX = p.x;
        if (p.y < minY) minY = p.y;
        if (p.x > maxX) maxX = p.x;
        if (p.y > maxY) maxY = p.y;
    });

    const rangeX = maxX - minX || 1;
    const rangeY = maxY - minY || 1;
    const svgW = 380, svgH = 380;
    const margin = 30;
    const drawW = svgW - 2 * margin;
    const drawH = svgH - 2 * margin;
    const scale = Math.min(drawW / rangeX, drawH / rangeY);
    const offX = margin + (drawW - rangeX * scale) / 2;
    const offY = margin + (drawH - rangeY * scale) / 2;

    // Transform: flip Y so Y-up
    function tx(x) { return offX + (x - minX) * scale; }
    function ty(y) { return offY + (maxY - y) * scale; }

    let html = '';

    // Grid lines
    html += '<rect x="0" y="0" width="400" height="400" fill="#fafbfc"/>';

    // Outer polygon
    const outerPts = outer.map(p => tx(p.x) + ',' + ty(p.y)).join(' ');
    html += `<polygon points="${outerPts}" fill="#e0e7ff" stroke="#2563eb" stroke-width="2"/>`;

    // Hollow polygon
    if (hollow.length >= 3) {
        const hollowPts = hollow.map(p => tx(p.x) + ',' + ty(p.y)).join(' ');
        html += `<polygon points="${hollowPts}" fill="#fafbfc" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4"/>`;
    }

    // Vertex labels for outer
    outer.forEach((p, i) => {
        const sx = tx(p.x), sy = ty(p.y);
        html += `<circle cx="${sx}" cy="${sy}" r="3" fill="#2563eb"/>`;
        html += `<text x="${sx + 5}" y="${sy - 5}" fill="#2563eb" font-size="9">${i + 1}</text>`;
    });

    // Rebars
    rebars.forEach((rb, i) => {
        const sx = tx(rb.x), sy = ty(rb.y);
        const info = rebarInfo[rb.no] || rebarInfo[8];
        const r = Math.max(3, info.dia * scale / 2);
        html += `<circle cx="${sx}" cy="${sy}" r="${Math.min(r, 8)}" fill="#ef4444" stroke="#b91c1c" stroke-width="1"/>`;
        const label = rb.no === 0 ? '自訂' : info.name.split(' ')[0];
        html += `<text x="${sx + 6}" y="${sy + 3}" fill="#b91c1c" font-size="8">${label}</text>`;
    });

    // 塑性中心與方位角
    if (rcColData.pcX !== null && rcColData.pcY !== null) {
        const pcSx = tx(rcColData.pcX), pcSy = ty(rcColData.pcY);
        // 塑性中心十字標記
        html += `<line x1="${pcSx-6}" y1="${pcSy}" x2="${pcSx+6}" y2="${pcSy}" stroke="#16a34a" stroke-width="2"/>`;
        html += `<line x1="${pcSx}" y1="${pcSy-6}" x2="${pcSx}" y2="${pcSy+6}" stroke="#16a34a" stroke-width="2"/>`;
        html += `<circle cx="${pcSx}" cy="${pcSy}" r="4" fill="none" stroke="#16a34a" stroke-width="1.5"/>`;
        html += `<text x="${pcSx+8}" y="${pcSy-8}" fill="#16a34a" font-size="9" font-weight="bold">PC</text>`;

        // 方位角箭頭
        if (rcColData.alpha !== null) {
            const alphaRad = rcColData.alpha * Math.PI / 180;
            const arrowLen = 40;
            // SVG Y 軸向下, 所以 dy 取負
            const ax = pcSx + arrowLen * Math.cos(alphaRad);
            const ay = pcSy - arrowLen * Math.sin(alphaRad);
            html += `<line x1="${pcSx}" y1="${pcSy}" x2="${ax}" y2="${ay}" stroke="#f59e0b" stroke-width="2.5" marker-end="url(#arrowAlpha)"/>`;
            // 箭頭 marker 定義
            html = `<defs><marker id="arrowAlpha" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#f59e0b"/></marker></defs>` + html;
            // 角度標示
            const labelX = pcSx + (arrowLen + 8) * Math.cos(alphaRad);
            const labelY = pcSy - (arrowLen + 8) * Math.sin(alphaRad);
            html += `<text x="${labelX}" y="${labelY}" fill="#f59e0b" font-size="10" font-weight="bold">α=${rcColData.alpha.toFixed(1)}°</text>`;
        }
    }

    // Axes label
    html += '<text x="10" y="395" fill="#94a3b8" font-size="10">單位: cm | Y↑ X→</text>';

    // Dimension labels
    html += `<text x="${tx(minX)}" y="${ty(minY) + 15}" fill="#64748b" font-size="9">(${minX},${minY})</text>`;
    html += `<text x="${tx(maxX) - 30}" y="${ty(maxY) - 5}" fill="#64748b" font-size="9">(${maxX},${maxY})</text>`;

    svg.innerHTML = html;
}

// 多邊形面積與重心 (Shoelace formula)
function polyProps(pts) {
    const n = pts.length;
    if (n < 3) return { area: 0, cx: 0, cy: 0 };
    let A = 0, Sx = 0, Sy = 0;
    for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        const cross = pts[i].x * pts[j].y - pts[j].x * pts[i].y;
        A += cross;
        Sx += (pts[i].x + pts[j].x) * cross;
        Sy += (pts[i].y + pts[j].y) * cross;
    }
    A /= 2; // signed area
    const area = Math.abs(A);
    if (area === 0) return { area: 0, cx: 0, cy: 0 };
    return { area, cx: Sx / (6 * A), cy: Sy / (6 * A) };
}

function calcRCColumn() {
    const outer = rcColData.outer;
    if (outer.length < 3) {
        alert('請輸入至少 3 個外輪廓頂點');
        return;
    }

    const fc = parseFloat(document.getElementById('rcc-fc').value) || 280;
    const fy = parseFloat(document.getElementById('rcc-fy').value) || 4200;
    const Mux = parseFloat(document.getElementById('rcc-Mux').value) || 0;
    const Muy = parseFloat(document.getElementById('rcc-Muy').value) || 0;

    // 外輪廓面積與重心
    const outerP = polyProps(outer);
    const areaGross = outerP.area;

    // 空心面積與重心
    const hollow = rcColData.hollow;
    const hollowP = polyProps(hollow);
    const areaHollow = hollowP.area;

    // 淨混凝土面積 (扣除空心與鋼筋)
    const rebars = rcColData.rebars;
    let totalAs = 0;
    rebars.forEach(rb => { totalAs += rb.area || (rebarInfo[rb.no] || rebarInfo[8]).area; });

    const areaNet = areaGross - areaHollow;
    const Ac = areaNet - totalAs; // 混凝土淨面積
    const rhoG = totalAs / areaNet * 100;

    // 塑性中心 (Plastic centroid)
    // 混凝土貢獻: 0.85*f'c * (Ag - Ahollow), 力矩用各區域幾何重心
    const concForce = 0.85 * fc * areaNet;
    let concMx = 0.85 * fc * areaGross * outerP.cx;
    let concMy = 0.85 * fc * areaGross * outerP.cy;
    if (areaHollow > 0) {
        concMx -= 0.85 * fc * areaHollow * hollowP.cx;
        concMy -= 0.85 * fc * areaHollow * hollowP.cy;
    }

    // 鋼筋貢獻: fy * As_i
    let steelForce = 0, steelMx = 0, steelMy = 0;
    rebars.forEach(rb => {
        const as = rb.area || (rebarInfo[rb.no] || rebarInfo[8]).area;
        const f = fy * as;
        steelForce += f;
        steelMx += f * rb.x;
        steelMy += f * rb.y;
    });

    const totalForce = concForce + steelForce;
    const pcX = totalForce !== 0 ? (concMx + steelMx) / totalForce : 0;
    const pcY = totalForce !== 0 ? (concMy + steelMy) / totalForce : 0;

    // 離心力方位角 α (以塑性中心為原點, Mux 對應 X 軸, Muy 對應 Y 軸)
    const alpha = Math.atan2(Muy, Mux) * 180 / Math.PI;

    // 儲存供預覽繪圖使用
    rcColData.pcX = pcX;
    rcColData.pcY = pcY;
    rcColData.alpha = alpha;
    drawRCColPreview();

    showResult('rccolumn', [
        ['毛斷面積 Ag', fmt(areaGross, 2) + ' cm²'],
        ['空心面積', fmt(areaHollow, 2) + ' cm²'],
        ['淨斷面積 (Ag-Ah)', fmt(areaNet, 2) + ' cm²'],
        ['混凝土淨面積 Ac', fmt(Ac, 2) + ' cm²'],
        ['總鋼筋面積 Ast', fmt(totalAs, 2) + ' cm²'],
        ['鋼筋比 ρg', fmt(rhoG, 2) + ' %'],
        ['鋼筋根數', rebars.length + ' 根'],
        ['塑性中心 Xpc', fmt(pcX, 2) + ' cm'],
        ['塑性中心 Ypc', fmt(pcY, 2) + ' cm'],
        ['離心力方位角 α', fmt(alpha, 2) + ' °'],
    ]);
}

// 初始化預設矩形斷面
function initRCColumn() {
    document.getElementById('rcc-preset').value = 'rect';
    onPresetChange('rect');
    updateCover();
}

// ===== 單位換算 =====
const unitData = {
    length: {
        units: ['mm', 'cm', 'm', 'km', 'in', 'ft', 'yd'],
        toBase: { mm: 0.001, cm: 0.01, m: 1, km: 1000, in: 0.0254, ft: 0.3048, yd: 0.9144 }
    },
    area: {
        units: ['mm\u00B2', 'cm\u00B2', 'm\u00B2', '\u5761', '\u7532', 'ft\u00B2', 'in\u00B2'],
        toBase: { 'mm\u00B2': 1e-6, 'cm\u00B2': 1e-4, 'm\u00B2': 1, '\u5761': 3305.785, '\u7532': 2934, 'ft\u00B2': 0.0929, 'in\u00B2': 6.4516e-4 }
    },
    volume: {
        units: ['cm\u00B3', 'm\u00B3', 'L', 'gal(US)'],
        toBase: { 'cm\u00B3': 1e-6, 'm\u00B3': 1, 'L': 0.001, 'gal(US)': 0.003785 }
    },
    force: {
        units: ['N', 'kN', 'kgf', 'tf', 'lbf'],
        toBase: { N: 1, kN: 1000, kgf: 9.80665, tf: 9806.65, lbf: 4.44822 }
    },
    pressure: {
        units: ['Pa', 'kPa', 'MPa', 'kgf/cm\u00B2', 'psi', 'atm', 'bar'],
        toBase: { Pa: 1, kPa: 1e3, MPa: 1e6, 'kgf/cm\u00B2': 98066.5, psi: 6894.76, atm: 101325, bar: 1e5 }
    },
    moment: {
        units: ['N\u00B7m', 'kN\u00B7m', 'kgf\u00B7cm', 'kgf\u00B7m', 'tf\u00B7m', 'tf\u00B7cm', 'N\u00B7mm', 'lbf\u00B7ft'],
        toBase: { 'N\u00B7m': 1, 'kN\u00B7m': 1000, 'kgf\u00B7cm': 0.0980665, 'kgf\u00B7m': 9.80665, 'tf\u00B7m': 9806.65, 'tf\u00B7cm': 98.0665, 'N\u00B7mm': 0.001, 'lbf\u00B7ft': 1.35582 }
    }
};

function updateUnitOptions() {
    const cat = sel('unit-cat');
    const units = unitData[cat].units;
    const fromSel = document.getElementById('unit-from');
    const toSel = document.getElementById('unit-to');
    fromSel.innerHTML = units.map((u, i) => `<option value="${u}" ${i === 0 ? 'selected' : ''}>${u}</option>`).join('');
    toSel.innerHTML = units.map((u, i) => `<option value="${u}" ${i === 1 ? 'selected' : ''}>${u}</option>`).join('');
}

function calcUnit() {
    const cat = sel('unit-cat');
    const v = val('unit-val');
    const from = sel('unit-from'), to = sel('unit-to');
    const base = unitData[cat].toBase;
    const result = v * base[from] / base[to];
    showResult('unit', [
        ['\u8F38\u5165', v + ' ' + from],
        ['\u7D50\u679C', fmt(result, 6) + ' ' + to],
    ]);
}

// Init
updateUnitOptions();
initUnitSelectors();
initRCColumn();
</script>

</body>
</html>
